<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTYD Randomizer</title>
    <meta name="description" content="A randomizer for the game TTYD, enhancing replayability with randomized items, enemies, and more.">
    <meta name="keywords" content="TTYD, randomizer, game, mod, Mario, Paper Mario, Thousand-Year Door, randomization">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='images/android-chrome-192x192.png') }}">
    <script src="{{ url_for('static', filename='js/theme-switcher.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-vivian.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-yoshi.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-goombella.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-msmowz.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-rawkhawk.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-doopliss.css') }}">
</head>
<body>
<div class="page-wrapper">
    <div class="header">
        <div class="header-logo">
            <a href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Home" class="logo">
            </a>
        </div>
        <div class="header-pages">
            <a href="#" id="recentSeedLink" class="pages-link" style="display: none;">Most Recent Seed</a>
            <a href="{{ url_for('generate') }}" class="pages-link">Seed Generator</a>
            <a href="{{ url_for('patch') }}" class="pages-link">Patch ROM</a>
            <a href="{{ url_for('about') }}" class="pages-link">About</a>
            <a href="{{ url_for('archipelago') }}" class="pages-link">Archipelago</a>
        </div>
    </div>

    <div class="generate-panel">
        <div class="preset-section">
            <h3 class="preset-header">Load Seed Patch</h3>
            <div class="preset-controls">
                <input type="file" id="patchFileInput" accept=".ttydp" style="display: none;" onchange="loadPatchFile(event)">
                <button class="preset-button" onclick="document.getElementById('patchFileInput').click()">
                    Load .ttydp Patch File
                </button>
                <p class="helper-text">
                    Load a patch file (.ttydp) to apply to your ROM.
                </p>
            </div>
        </div>

        <div class="preset-section">
            <h3 class="preset-header">Preset Settings</h3>
            <div class="preset-controls">
                <select class="preset-dropdown" onchange="loadPreset()">
                    <option value="">Select a preset to load...</option>
                    <option data-settings="eyJuYW1lIjoiUGxheWVyMSIsImRlc2NyaXB0aW9uIjoiVFRZRCBSYW5kb21pemVyIFdlYiBDb25maWd1cmF0aW9uIiwiZ2FtZSI6IlBhcGVyIE1hcmlvOiBUaGUgVGhvdXNhbmQtWWVhciBEb29yIiwiUGFwZXIgTWFyaW86IFRoZSBUaG91c2FuZC1ZZWFyIERvb3IiOnsiZGVhdGhfbGluayI6ZmFsc2UsInRhdHRsZXNhbml0eSI6ZmFsc2UsInNob3BzYW5pdHkiOnRydWUsInNoaW5lc2FuaXR5Ijp0cnVlLCJsaW1pdF9jaGFwdGVyX2xvZ2ljIjpmYWxzZSwibGltaXRfY2hhcHRlcl9laWdodCI6ZmFsc2UsInBhbGFjZV9za2lwIjpmYWxzZSwiY3V0c2NlbmVfc2tpcCI6ZmFsc2UsImRpc2FibGVfaW50ZXJtaXNzaW9ucyI6ZmFsc2UsIm9wZW5fd2VzdHNpZGUiOmZhbHNlLCJmYXN0X3RyYXZlbCI6ZmFsc2UsInN1Y2NlZWRfY29uZGl0aW9ucyI6ZmFsc2UsInBlcm1hbmVudF9wZWVrYWJvbyI6ZmFsc2UsImZ1bGxfcnVuX2JhciI6ZmFsc2UsImZpcnN0X2F0dGFjayI6ZmFsc2UsImdvYWwiOiJzaGFkb3dfcXVlZW4iLCJwaXRfaXRlbXMiOiJmaWxsZXIiLCJhY2Nlc3NpYmlsaXR5IjoiZnVsbCIsInBpZWNlc2FuaXR5Ijoibm9ucGFuZWxfb25seSIsInN0YXJfc2h1ZmZsZSI6InN0YXJzX29ubHkiLCJkYXp6bGVfcmV3YXJkcyI6ImFsbCIsInN0YXJ0aW5nX3BhcnRuZXIiOiJnb29tYmVsbGEiLCJtdXNpY19zZXR0aW5ncyI6Im5vcm1hbCIsImJsb2NrX3Zpc2liaWxpdHkiOiJub3JtYWwiLCJ5b3NoaV9jb2xvciI6ImdyZWVuIiwieW9zaGlfbmFtZSI6Illvc2hpIiwiZ29hbF9zdGFycyI6NywicGFsYWNlX3N0YXJzIjo3LCJzdGFydGluZ19ocCI6MTAsInN0YXJ0aW5nX2ZwIjo1LCJzdGFydGluZ19icCI6Mywic3RhcnRpbmdfY29pbnMiOjEwMCwic3RhcnRpbmdfbGV2ZWwiOjEsImV4cGVyaWVuY2VfbXVsdGlwbGllciI6MSwicHJvZ3Jlc3Npb25fYmFsYW5jaW5nIjo1MH19">Default Settings</option>
                    <option data-settings="eyJuYW1lIjoiUGxheWVyMSIsImRlc2NyaXB0aW9uIjoiVFRZRCBSYW5kb21pemVyIFdlYiBDb25maWd1cmF0aW9uIiwiZ2FtZSI6IlBhcGVyIE1hcmlvOiBUaGUgVGhvdXNhbmQtWWVhciBEb29yIiwiUGFwZXIgTWFyaW86IFRoZSBUaG91c2FuZC1ZZWFyIERvb3IiOnsiZGVhdGhfbGluayI6ZmFsc2UsInRhdHRsZXNhbml0eSI6ZmFsc2UsInNob3BzYW5pdHkiOnRydWUsInNoaW5lc2FuaXR5Ijp0cnVlLCJsaW1pdF9jaGFwdGVyX2xvZ2ljIjp0cnVlLCJsaW1pdF9jaGFwdGVyX2VpZ2h0Ijp0cnVlLCJwYWxhY2Vfc2tpcCI6ZmFsc2UsImN1dHNjZW5lX3NraXAiOmZhbHNlLCJkaXNhYmxlX2ludGVybWlzc2lvbnMiOmZhbHNlLCJvcGVuX3dlc3RzaWRlIjp0cnVlLCJmYXN0X3RyYXZlbCI6ZmFsc2UsInN1Y2NlZWRfY29uZGl0aW9ucyI6ZmFsc2UsInBlcm1hbmVudF9wZWVrYWJvbyI6dHJ1ZSwiZnVsbF9ydW5fYmFyIjpmYWxzZSwiZmlyc3RfYXR0YWNrIjp0cnVlLCJnb2FsIjoiY3J5c3RhbF9zdGFycyIsInBpdF9pdGVtcyI6InZhbmlsbGEiLCJhY2Nlc3NpYmlsaXR5IjoiZnVsbCIsInBpZWNlc2FuaXR5IjoidmFuaWxsYSIsInN0YXJfc2h1ZmZsZSI6InZhbmlsbGEiLCJkYXp6bGVfcmV3YXJkcyI6InZhbmlsbGEiLCJzdGFydGluZ19wYXJ0bmVyIjoiZ29vbWJlbGxhIiwibXVzaWNfc2V0dGluZ3MiOiJub3JtYWwiLCJibG9ja192aXNpYmlsaXR5IjoiYWxsX3Zpc2libGUiLCJ5b3NoaV9jb2xvciI6ImdyZWVuIiwieW9zaGlfbmFtZSI6Illvc2hpIiwiZ29hbF9zdGFycyI6MywicGFsYWNlX3N0YXJzIjozLCJzdGFydGluZ19ocCI6MjAsInN0YXJ0aW5nX2ZwIjoxMCwic3RhcnRpbmdfYnAiOjksInN0YXJ0aW5nX2NvaW5zIjoyMDAsInN0YXJ0aW5nX2xldmVsIjoxLCJleHBlcmllbmNlX211bHRpcGxpZXIiOjIsInByb2dyZXNzaW9uX2JhbGFuY2luZyI6NTB9fQ">Beginner Mode</option>
                    <option data-settings="eyJuYW1lIjoiUGxheWVyMSIsImRlc2NyaXB0aW9uIjoiVFRZRCBSYW5kb21pemVyIFdlYiBDb25maWd1cmF0aW9uIiwiZ2FtZSI6IlBhcGVyIE1hcmlvOiBUaGUgVGhvdXNhbmQtWWVhciBEb29yIiwiUGFwZXIgTWFyaW86IFRoZSBUaG91c2FuZC1ZZWFyIERvb3IiOnsiZGVhdGhfbGluayI6ZmFsc2UsInRhdHRsZXNhbml0eSI6dHJ1ZSwic2hvcHNhbml0eSI6dHJ1ZSwic2hpbmVzYW5pdHkiOnRydWUsImxpbWl0X2NoYXB0ZXJfbG9naWMiOmZhbHNlLCJsaW1pdF9jaGFwdGVyX2VpZ2h0IjpmYWxzZSwicGFsYWNlX3NraXAiOnRydWUsImN1dHNjZW5lX3NraXAiOnRydWUsImRpc2FibGVfaW50ZXJtaXNzaW9ucyI6dHJ1ZSwib3Blbl93ZXN0c2lkZSI6ZmFsc2UsImZhc3RfdHJhdmVsIjp0cnVlLCJzdWNjZWVkX2NvbmRpdGlvbnMiOnRydWUsInBlcm1hbmVudF9wZWVrYWJvbyI6dHJ1ZSwiZnVsbF9ydW5fYmFyIjp0cnVlLCJmaXJzdF9hdHRhY2siOmZhbHNlLCJnb2FsIjoic2hhZG93X3F1ZWVuIiwicGl0X2l0ZW1zIjoiYWxsIiwiYWNjZXNzaWJpbGl0eSI6ImZ1bGwiLCJwaWVjZXNhbml0eSI6ImFsbCIsInN0YXJfc2h1ZmZsZSI6InN0YXJzX29ubHkiLCJkYXp6bGVfcmV3YXJkcyI6ImFsbCIsInN0YXJ0aW5nX3BhcnRuZXIiOiJnb29tYmVsbGEiLCJtdXNpY19zZXR0aW5ncyI6Im5vcm1hbCIsImJsb2NrX3Zpc2liaWxpdHkiOiJub3JtYWwiLCJ5b3NoaV9jb2xvciI6ImdyZWVuIiwieW9zaGlfbmFtZSI6Illvc2hpIiwiZ29hbF9zdGFycyI6NywicGFsYWNlX3N0YXJzIjowLCJzdGFydGluZ19ocCI6MTAsInN0YXJ0aW5nX2ZwIjo1LCJzdGFydGluZ19icCI6Mywic3RhcnRpbmdfY29pbnMiOjEwMCwic3RhcnRpbmdfbGV2ZWwiOjEsImV4cGVyaWVuY2VfbXVsdGlwbGllciI6MSwicHJvZ3Jlc3Npb25fYmFsYW5jaW5nIjo1MH19">Expert Shuffle</option>
                    <option data-settings="eyJuYW1lIjoiUGxheWVyMSIsImRlc2NyaXB0aW9uIjoiVFRZRCBSYW5kb21pemVyIFdlYiBDb25maWd1cmF0aW9uIiwiZ2FtZSI6IlBhcGVyIE1hcmlvOiBUaGUgVGhvdXNhbmQtWWVhciBEb29yIiwiUGFwZXIgTWFyaW86IFRoZSBUaG91c2FuZC1ZZWFyIERvb3IiOnsiZGVhdGhfbGluayI6ZmFsc2UsInRhdHRsZXNhbml0eSI6ZmFsc2UsInNob3BzYW5pdHkiOnRydWUsInNoaW5lc2FuaXR5Ijp0cnVlLCJsaW1pdF9jaGFwdGVyX2xvZ2ljIjpmYWxzZSwibGltaXRfY2hhcHRlcl9laWdodCI6ZmFsc2UsInBhbGFjZV9za2lwIjp0cnVlLCJjdXRzY2VuZV9za2lwIjp0cnVlLCJkaXNhYmxlX2ludGVybWlzc2lvbnMiOnRydWUsIm9wZW5fd2VzdHNpZGUiOmZhbHNlLCJmYXN0X3RyYXZlbCI6dHJ1ZSwic3VjY2VlZF9jb25kaXRpb25zIjp0cnVlLCJwZXJtYW5lbnRfcGVla2Fib28iOnRydWUsImZ1bGxfcnVuX2JhciI6dHJ1ZSwiZmlyc3RfYXR0YWNrIjpmYWxzZSwiZ29hbCI6InNoYWRvd19xdWVlbiIsInBpdF9pdGVtcyI6ImZpbGxlciIsImFjY2Vzc2liaWxpdHkiOiJmdWxsIiwicGllY2VzYW5pdHkiOiJhbGwiLCJzdGFyX3NodWZmbGUiOiJ2YW5pbGxhIiwiZGF6emxlX3Jld2FyZHMiOiJ2YW5pbGxhIiwic3RhcnRpbmdfcGFydG5lciI6Imdvb21iZWxsYSIsIm11c2ljX3NldHRpbmdzIjoibm9ybWFsIiwiYmxvY2tfdmlzaWJpbGl0eSI6Im5vcm1hbCIsInlvc2hpX2NvbG9yIjoiZ3JlZW4iLCJ5b3NoaV9uYW1lIjoiWW9zaGkiLCJnb2FsX3N0YXJzIjo3LCJwYWxhY2Vfc3RhcnMiOjQsInN0YXJ0aW5nX2hwIjoxMCwic3RhcnRpbmdfZnAiOjEwLCJzdGFydGluZ19icCI6Mywic3RhcnRpbmdfY29pbnMiOjIwMCwic3RhcnRpbmdfbGV2ZWwiOjEsImV4cGVyaWVuY2VfbXVsdGlwbGllciI6MSwicHJvZ3Jlc3Npb25fYmFsYW5jaW5nIjo1MH19">Race Settings</option>
                </select>
                <button class="preset-button" onclick="savePreset()">Save as New Preset</button>
                <button class="delete-preset-button" id="deletePresetBtn" onclick="deleteCurrentPreset()" style="display: none;">Delete Preset</button>
            </div>

            <div class="settings-string-section">
                <label class="settings-string-label">Settings String</label>
                <div class="settings-string-controls">
                    <input type="text" class="settings-string-input" id="settingsStringInput" placeholder="Paste settings string here...">
                    <button class="preset-button" onclick="exportToField()">Export</button>
                    <button class="preset-button" onclick="importFromField()">Import</button>
                </div>
            </div>

            <div class="settings-string-section">
                <label class="settings-string-label">Export Settings as YAML</label>
                <div class="settings-string-controls">
                    <input type="text" class="settings-string-input" id="playerNameInput" placeholder="Player Name" maxlength="16">
                    <button class="preset-button" onclick="exportYAMLFile()">Export YAML File</button>
                </div>
                <p class="helper-text">Download current settings as a .yaml file compatible with Archipelago.</p>
            </div>
        </div>

        <div class="panel-tabs">
            <button class="panel-tab active" onclick="switchTab(this, 'logic')">Logic & Progression</button>
            <button class="panel-tab" onclick="switchTab(this, 'world')">World & Gameplay</button>
            <button class="panel-tab" onclick="switchTab(this, 'stats')">Starting Stats</button>
            <button class="panel-tab" onclick="switchTab(this, 'qol')">Quality of Life</button>
            <button class="panel-tab" onclick="switchTab(this, 'archipelago')">Archipelago Settings</button>
        </div>

        <div class="generate-content">
            <!-- Logic & Progression Tab -->
            <div id="logic" class="panel-content active">
                <div class="settings-grid">
                    <div class="dropdown-container">
                        <span class="dropdown-label">Goal<span class="help-icon" data-tooltip="This determines the goal of the game. Shadow Queen: Defeat the Shadow Queen. Crystal Stars: Collect a specified amount of Crystal Stars. Bonetail: Defeat Bonetail.">?</span></span>
                        <select class="dropdown-select goal-dropdown">
                            <option value="0" selected>Shadow Queen</option>
                            <option value="1">Crystal Stars</option>
                            <option value="2">Bonetail</option>
                        </select>
                    </div>

                    <div class="number-container">
                        <span class="number-label">Goal Crystal Stars<span class="help-icon" data-tooltip="This determines how many crystal stars are required for the goal option Crystal Stars. This is only used if the goal option is set to Crystal Stars.">?</span></span>
                        <input type="number" class="number-input" min="0" max="7" value="7">
                    </div>

                    <div class="number-container">
                        <span class="number-label">Palace Crystal Stars<span class="help-icon" data-tooltip="This determines how many Crystal Stars are required to enter the Palace of Shadow.">?</span></span>
                        <input type="number" class="number-input" min="0" max="7" value="7">
                    </div>

                    <div class="dropdown-container">
                        <span class="dropdown-label">Pit Items<span class="help-icon" data-tooltip="This determines what type of items are in the Pit of 100 Trials. Vanilla: The locations contain the same items as the original game, and the locations themselves will not be created. Filler: The locations will be marked as excluded. All: The locations can contain any item.">?</span></span>
                        <select class="dropdown-select">
                            <option value="0">Vanilla</option>
                            <option value="1" selected>Filler</option>
                            <option value="2">All</option>
                        </select>
                    </div>
                    <div class="dropdown-container">
                        <span class="dropdown-label">Accessibility<span class="help-icon" data-tooltip="Set rules for reachability of your items/locations. Full: ensure everything can be reached and acquired. Minimal: ensure what is needed to reach your goal can be acquired.">?</span></span>
                        <select class="dropdown-select">
                            <option value="0" selected>Full</option>
                            <option value="1">Minimal</option>
                        </select>
                    </div>


                    <div class="toggle-container">
                        <span class="toggle-label">Tattlesanity<span class="help-icon" data-tooltip="Creates a location for every enemy being tattled. All key items can possibly be placed in these locations.">?</span></span>
                        <div class="toggle-switch" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="dropdown-container">
                        <span class="dropdown-label">Piecesanity<span class="help-icon" data-tooltip="Shuffles Star Piece collection. Vanilla: no changes. Non-Panel Only: only non-panel pieces shuffled. All: all star pieces shuffled.">?</span></span>
                        <select class="dropdown-select">
                            <option value="0">Vanilla</option>
                            <option value="1" selected>Non-Panel Only</option>
                            <option value="2">All</option>
                        </select>
                    </div>

                    <div class="toggle-container">
                        <span class="toggle-label">Shopsanity<span class="help-icon" data-tooltip="When enabled, shop purchases become location checks that can contain any item.">?</span></span>
                        <div class="toggle-switch active" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="toggle-container">
                        <span class="toggle-label">Shinesanity<span class="help-icon" data-tooltip="Shine Sprites will be randomized.">?</span></span>
                        <div class="toggle-switch active" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="dropdown-container">
                        <span class="dropdown-label">Star Shuffle<span class="help-icon" data-tooltip="Crystal Stars will be added as items to the item pool. Vanilla: Crystal Stars remain in their original locations. Stars Only: Crystal Stars shuffled into other crystal star locations. All: Crystal Stars shuffled into any location.">?</span></span>
                        <select class="dropdown-select">
                            <option value="1" selected>Vanilla</option>
                            <option value="2">Stars Only</option>
                            <option value="3">All</option>
                        </select>
                    </div>

                    <div class="dropdown-container">
                        <span class="dropdown-label">Dazzle Rewards<span class="help-icon" data-tooltip="This determines what type of items are given as rewards by Dazzle. Vanilla: The rewards are the same as the original game. Filler: The rewards will be non-progression items. All: The rewards can be any item.">?</span></span>
                        <select class="dropdown-select">
                            <option value="1">Vanilla</option>
                            <option value="2">Filler</option>
                            <option value="3" selected>All</option>
                        </select>
                    </div>

                    <div class="toggle-container">
                        <span class="toggle-label">Limit Chapter Logic<span class="help-icon" data-tooltip="Progression items will only appear in required chapters, and in common areas. You will not need to check the chapters that are out of logic whatsoever.">?</span></span>
                        <div class="toggle-switch" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="toggle-container">
                        <span class="toggle-label">Limit Chapter 8<span class="help-icon" data-tooltip="All chapter 8 key items will be placed in vanilla locations. All other locations will have non-progression items.">?</span></span>
                        <div class="toggle-switch" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- World & Gameplay Tab -->
            <div id="world" class="panel-content">
                <div class="settings-grid">
                    <div class="toggle-container">
                        <span class="toggle-label">Palace Skip<span class="help-icon" data-tooltip="Entering the Thousand-Year door will take you straight to Grodus.">?</span></span>
                        <div class="toggle-switch" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="toggle-container">
                        <span class="toggle-label">Skip Cutscenes<span class="help-icon" data-tooltip="Skips some of the longer cutscenes in the game, such as the Shadow Queen cutscene, Fahr Outpost Cannon etc.">?</span></span>
                        <div class="toggle-switch" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="toggle-container">
                        <span class="toggle-label">Disable Intermissions<span class="help-icon" data-tooltip="After obtaining a crystal star, mario will stay in the boss' room, and the sequence will be updated past the intermission.">?</span></span>
                        <div class="toggle-switch" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="toggle-container">
                        <span class="toggle-label">Open West Side<span class="help-icon" data-tooltip="Rogueport Westside is open from the start.">?</span></span>
                        <div class="toggle-switch" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="toggle-container">
                        <span class="toggle-label">Fast Travel<span class="help-icon" data-tooltip="Enable this to gain the ability to warp to any area you have visited from the map screen in the main menu. Press A on the destination to open the warp confirmation dialog.">?</span></span>
                        <div class="toggle-switch" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="toggle-container">
                        <span class="toggle-label">Always Succeed Conditions<span class="help-icon" data-tooltip="Enable this to make it so the battle condition in fights in the Glitz Pit will always be fulfilled, regardless of their actual fulfillment.">?</span></span>
                        <div class="toggle-switch" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Starting Stats Tab -->
            <div id="stats" class="panel-content">
                <div class="settings-grid">
                    <div class="number-container">
                        <span class="number-label">Starting HP<span class="help-icon" data-tooltip="How much health you start with.">?</span></span>
                        <input type="number" class="number-input" min="1" max="100" value="10">
                    </div>

                    <div class="number-container">
                        <span class="number-label">Starting FP<span class="help-icon" data-tooltip="How much flower points you start with.">?</span></span>
                        <input type="number" class="number-input" min="0" max="100" value="5">
                    </div>

                    <div class="number-container">
                        <span class="number-label">Starting BP<span class="help-icon" data-tooltip="How many badge points you start with.">?</span></span>
                        <input type="number" class="number-input" min="0" max="99" value="3">
                    </div>

                    <div class="number-container">
                        <span class="number-label">Starting Coins<span class="help-icon" data-tooltip="How many coins you start with.">?</span></span>
                        <input type="number" class="number-input" min="0" max="999" value="100">
                    </div>

                    <div class="number-container">
                        <span class="number-label">Starting Level<span class="help-icon" data-tooltip="What level you start at.">?</span></span>
                        <input type="number" class="number-input" min="1" max="99" value="1">
                    </div>

                    <div class="number-container">
                        <span class="number-label">Experience Multiplier<span class="help-icon" data-tooltip="Multiplies the experience you gain from battles.">?</span></span>
                        <input type="number" class="number-input" min="0" max="10" value="1">
                    </div>

                    <div class="dropdown-container">
                        <span class="dropdown-label">Starting Partner<span class="help-icon" data-tooltip="Choose the partner that you start with.">?</span></span>
                        <select class="dropdown-select">
                            <option value="1" selected>Goombella</option>
                            <option value="2">Koops</option>
                            <option value="3">Bobbery</option>
                            <option value="4">Yoshi</option>
                            <option value="5">Flurrie</option>
                            <option value="6">Vivian</option>
                            <option value="7">Ms. Mowz</option>
                            <option value="8">Random Partner</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Quality of Life Tab -->
            <div id="qol" class="panel-content">
                <div class="settings-grid">
                    <div class="toggle-container">
                        <span class="toggle-label">Permanent Peekaboo<span class="help-icon" data-tooltip="The Peekaboo badge is always active, even when not equipped.">?</span></span>
                        <div class="toggle-switch" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="toggle-container">
                        <span class="toggle-label">Full Run Bar<span class="help-icon" data-tooltip="The run bar in battle always starts at 100 percent.">?</span></span>
                        <div class="toggle-switch" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="toggle-container">
                        <span class="toggle-label">First Attack<span class="help-icon" data-tooltip="The First Attack badge costs 0 BP, just like the remake.">?</span></span>
                        <div class="toggle-switch" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="dropdown-container">
                        <span class="dropdown-label">Music Settings<span class="help-icon" data-tooltip="Choose in-game music settings. Normal: Music will not change. Silent: No music will play at all. Randomized: Music will be randomized.">?</span></span>
                        <select class="dropdown-select">
                            <option value="0" selected>Normal</option>
                            <option value="1">Silent</option>
                            <option value="2">Randomized</option>
                        </select>
                    </div>

                    <div class="dropdown-container">
                        <span class="dropdown-label">Block Visibility<span class="help-icon" data-tooltip="Choose how visible item blocks are. Normal: All blocks will keep their vanilla visibility. All Visible: All blocks will be visible.">?</span></span>
                        <select class="dropdown-select">
                            <option value="0" selected>Normal</option>
                            <option value="1">All Visible</option>
                        </select>
                    </div>

                    <div class="dropdown-container">
                        <span class="dropdown-label">Yoshi Color<span class="help-icon" data-tooltip="Select the color of your Yoshi partner.">?</span></span>
                        <select class="dropdown-select">
                            <option value="0" selected>Green</option>
                            <option value="1">Red</option>
                            <option value="2">Blue</option>
                            <option value="3">Orange</option>
                            <option value="4">Pink</option>
                            <option value="5">Black</option>
                            <option value="6">White</option>
                            <option value="7">Random Color</option>
                        </select>
                    </div>

                    <div class="text-container">
                        <span class="text-label">Yoshi Name<span class="help-icon" data-tooltip="Set the name of your Yoshi partner. This has a maximum length of 8 characters.">?</span></span>
                        <input type="text" class="text-input" maxlength="8" value="Yoshi">
                    </div>
                </div>
            </div>

            <!-- Archipelago Settings Tab -->
            <div id="archipelago" class="panel-content">
                <div class="settings-grid">
                    <div class="number-container">
                        <span class="number-label">Progression Balancing<span class="help-icon" data-tooltip="A system that can move progression earlier, to try and prevent the player from getting stuck and bored early. A lower setting means more getting stuck. A higher setting means less getting stuck. Meant for Archipelago multiworld only. Has no effect in single-player mode.">?</span></span>
                        <input type="number" class="number-input" min="0" max="99" value="50">
                    </div>

                    <div class="toggle-container">
                        <span class="toggle-label">Death Link<span class="help-icon" data-tooltip="When you die, everyone dies. Meant for Archipelago multiworld only. Has no effect in single-player mode.">?</span></span>
                        <div class="toggle-switch" onclick="toggleSwitch(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Generation Section -->
        <!-- Plando Items Section -->
        <div class="preset-section" style="margin-top: 20px;">
            <h3 class="preset-header">Plando Items (Optional)</h3>
            <p style="padding: 10px; font-size: 0.9em;">
                Force specific items to spawn at specific locations. Select an item for any location, or leave as "No Plando" to randomize normally.
            </p>
            <div style="padding: 15px;">
                <div style="margin-bottom: 10px;">
                    <input type="text" id="plandoSearchBox" placeholder="Search locations..."
                           class="settings-string-input" style="width: 100%; margin-bottom: 10px;">
                </div>
                <div id="plandoContainer" style="max-height: 400px; overflow-y: auto; border: 1px solid; border-radius: 5px; padding: 10px;"></div>
            </div>
        </div>

        <div class="iso-generation-section">
            <h3>Generate Seed</h3>
            <div class="seed-input-section" style="margin-top: 10px;">
                <label class="settings-string-label">Seed (optional)</label>
                <div class="settings-string-controls">
                    <input type="text" class="settings-string-input" id="seedInput">
                    <button class="preset-button" onclick="generateRandomSeed()">Random</button>
                </div>
            </div>
            <div class="iso-controls" style="margin-top: 10px;">
                <button class="preset-button" id="generateBtn" onclick="generateRandomizedROM()">Generate Seed</button>
            </div>
            <div id="downloadSection" style="margin-top: 15px; display: none;">
                <h4>Download Generated Files:</h4>
                <div id="downloadLinks"></div>
            </div>
        </div>
    </div>

    <!-- Modal System -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <h2 class="modal-title" id="modalTitle"></h2>
            <p class="modal-message" id="modalMessage"></p>
            <input type="text" class="modal-input" id="modalInput" style="display: none;">
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>
</div>

<script>
    /**
     * Convert any seed value (string or number) to a consistent integer
     * Uses a simple hash function for strings
     */
    function convertSeedToInt(seed) {
        // If empty, null, or undefined, return null (random seed)
        if (!seed || seed.toString().trim() === '') {
            return null;
        }

        // If already a valid integer, return it
        const parsed = parseInt(seed);
        if (!isNaN(parsed) && parsed.toString() === seed.toString().trim()) {
            return parsed;
        }

        // For strings, convert to int using a hash function
        // This ensures the same string always produces the same seed
        const str = seed.toString();
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32-bit integer
        }
        // Return absolute value to ensure positive integer
        return Math.abs(hash);
    }

    /**
     * Generate a random seed value
     */
    function generateRandomSeed() {
        const randomSeed = Math.floor(Math.random() * 2147483647); // Max 32-bit int
        document.getElementById('seedInput').value = randomSeed;
    }

    /**
     * Export current settings as YAML file
     */
    function exportYAMLFile() {
        try {
            // Collect current settings from UI
            const settings = collectSettingsFromUI();
            
            // Get player name from input field
            const playerNameInput = document.getElementById('playerNameInput');
            const playerName = playerNameInput ? playerNameInput.value.trim() : '';
            
            // Update settings with player name if provided
            if (playerName) {
                settings.name = playerName;
            }
            
            // Convert settings to YAML format
            const yamlContent = convertToYAML(settings);
            
            // Create and download the file
            const blob = new Blob([yamlContent], { type: 'text/yaml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            // Create download link
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            const fileName = playerName ? `${playerName}-ttyd-settings.yaml` : `ttyd-randomizer-settings-${Date.now()}.yaml`;
            downloadLink.download = fileName;
            
            // Trigger download
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // Clean up
            URL.revokeObjectURL(url);
            
            console.log('YAML settings exported successfully');
        } catch (error) {
            console.error('Error exporting YAML:', error);
            showModal('Export Error', `Failed to export YAML file: ${error.message}`);
        }
    }

    /**
     * Convert settings object to YAML format
     * This creates a basic YAML structure that matches the expected format for the generator
     */
    function convertToYAML(settings) {
        const lines = [];
        
        // Add header comment
        lines.push('# TTYD Randomizer Settings');
        lines.push('# Generated from TTYD Randomizer Web Interface');
        lines.push(`# Created: ${new Date().toISOString()}`);
        lines.push('');
        
        // Add top-level settings
        lines.push(`name: "${settings.name}"`);
        lines.push(`description: "${settings.description}"`);
        lines.push(`game: "${settings.game}"`);
        lines.push('');
        
        // Add game-specific settings
        const gameKey = settings.game;
        const gameSettings = settings[gameKey];
        
        lines.push(`"${gameKey}":`);
        
        // Sort settings alphabetically for consistent output
        const sortedKeys = Object.keys(gameSettings).sort();
        
        for (const key of sortedKeys) {
            const value = gameSettings[key];
            
            if (typeof value === 'string') {
                lines.push(`  ${key}: "${value}"`);
            } else if (typeof value === 'boolean') {
                lines.push(`  ${key}: ${value}`);
            } else if (typeof value === 'number') {
                lines.push(`  ${key}: ${value}`);
            } else {
                // For any other type, stringify it
                lines.push(`  ${key}: ${JSON.stringify(value)}`);
            }
        }
        
        return lines.join('\n');
    }

    /**
     * Main generation function called by the Generate button
     * Collects settings from UI and sends to Flask backend
     */
    async function generateRandomizedROM() {
        const generateBtn = document.getElementById('generateBtn');
        const originalText = generateBtn.textContent;

        try {
            // Disable button and show progress
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';

            console.log('ðŸŽ¯ Starting ROM generation...');

            // Collect settings from UI
            const settings = collectSettingsFromUI();

            // Get player name from input field
            const playerNameInput = document.getElementById('playerNameInput');
            const playerName = playerNameInput ? playerNameInput.value.trim() : '';

            // Add player name to settings if provided
            if (playerName) {
                settings.name = playerName;
            }

            // Collect plando items
            const plandoItems = collectPlandoItems();
            if (plandoItems) {
                // Add plando_items to the game settings
                if (!settings['Paper Mario: The Thousand-Year Door']) {
                    settings['Paper Mario: The Thousand-Year Door'] = {};
                }
                settings['Paper Mario: The Thousand-Year Door'].plando_items = plandoItems;
                console.log('Plando items:', plandoItems);
            }

            // Handle seed conversion - only add seed if user provided one
            const seedInput = document.getElementById('seedInput').value;
            const convertedSeed = convertSeedToInt(seedInput);

            if (convertedSeed !== null) {
                // Add seed at top level for Flask to pass to --seed flag
                settings.seed = convertedSeed;
                console.log(`Seed input: "${seedInput}" -> ${convertedSeed}`);
            } else {
                // Generate a random 64-bit integer as fallback seed
                const randomSeed = Math.floor(Math.random() * Number.MAX_SAFE_INTEGER);
                settings.seed = randomSeed;
                console.log(`No seed provided, using random seed: ${randomSeed}`);
            }

            console.log('Collected settings:', settings);

            // Send settings to Flask backend
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            });

            const result = await response.json();
            console.log('Generation result:', result);

            if (response.ok && result) {
                // Store seed data in sessionStorage (for backwards compatibility)
                const seedData = {
                    locations: result.locations || result,
                    seed: result.seed,
                    required_chapters: result.required_chapters,
                    seed_id: result.seed_id,
                    settings: settings,
                    timestamp: Date.now()
                };
                sessionStorage.setItem('ttydSeedData', JSON.stringify(seedData));

                // Store most recent seed ID in localStorage
                localStorage.setItem('ttyd_most_recent_seed', result.seed_id);

                // Redirect to result page with seed_id in URL
                window.location.href = `/result/${result.seed_id}`;
            } else {
                showModal('Error', `Generation failed: ${result.error}`);
                if (result.traceback) {
                    console.error('Traceback:', result.traceback);
                }
            }

        } catch (error) {
            console.error('Generation failed:', error);
            showModal('Error', `Generation failed: ${error.message}`);
        } finally {
            // Re-enable button
            generateBtn.disabled = false;
            generateBtn.textContent = originalText;
        }
    }

    /**
     * Collect all settings from the UI elements and format for Archipelago YAML
     * FIX: Now correctly strips the '?' from the help icon in the label text.
     */
    function collectSettingsFromUI() {
        // Map UI labels to YAML option names
        const labelToOption = {
            // Logic & Progression
            'Goal': 'goal',
            'Goal Crystal Stars': 'goal_stars',
            'Palace Crystal Stars': 'palace_stars',
            'Pit Items': 'pit_items',
            'Progression Balancing': 'progression_balancing',
            'Accessibility': 'accessibility',
            'Death Link': 'death_link',
            'Tattlesanity': 'tattlesanity',
            'Piecesanity': 'piecesanity',
            'Shopsanity': 'shopsanity',
            'Shinesanity': 'shinesanity',
            'Star Shuffle': 'star_shuffle',
            'Dazzle Rewards': 'dazzle_rewards',
            'Limit Chapter Logic': 'limit_chapter_logic',
            'Limit Chapter 8': 'limit_chapter_eight',

            // World & Gameplay
            'Palace Skip': 'palace_skip',
            'Skip Cutscenes': 'cutscene_skip',
            'Disable Intermissions': 'disable_intermissions',
            'Open West Side': 'open_westside',
            'Fast Travel': 'fast_travel',
            'Always Succeed Conditions': 'succeed_conditions',

            // Starting Stats
            'Starting HP': 'starting_hp',
            'Starting FP': 'starting_fp',
            'Starting BP': 'starting_bp',
            'Starting Coins': 'starting_coins',
            'Starting Level': 'starting_level',
            'Experience Multiplier': 'experience_multiplier',
            'Starting Partner': 'starting_partner',

            // Quality of Life
            'Permanent Peekaboo': 'permanent_peekaboo',
            'Full Run Bar': 'full_run_bar',
            'First Attack': 'first_attack',
            'Music Settings': 'music_settings',
            'Block Visibility': 'block_visibility',
            'Yoshi Color': 'yoshi_color',
            'Yoshi Name': 'yoshi_name'
        };

        // Helper function to extract and clean the label text
        const cleanLabelText = (element) => {
            // Get the full text content, trim it, and remove any trailing non-word characters (like '?')
            let label = element.textContent.trim();
            // The regex /\W+$/ matches one or more non-word characters at the end of the string
            label = label.replace(/\W+$/, '').trim();
            return label;
        };

        const settings = {
            name: "Player1",
            description: "TTYD Randomizer Web Configuration",
            game: "Paper Mario: The Thousand-Year Door",
            "Paper Mario: The Thousand-Year Door": {}
        };

        const gameSettings = settings["Paper Mario: The Thousand-Year Door"];

        // Set death_link default to false (not exposed in UI)
        gameSettings.death_link = false;

        // Collect toggle switches (boolean values)
        const toggles = document.querySelectorAll('.toggle-switch');
        toggles.forEach(toggle => {
            const labelElement = toggle.parentElement.querySelector('.toggle-label');
            if (!labelElement) return;

            const label = cleanLabelText(labelElement); // Use the corrected label
            const optionName = labelToOption[label];
            if (optionName) {
                const isActive = toggle.classList.contains('active');
                gameSettings[optionName] = isActive;
            }
        });

        // Collect dropdowns
        const dropdowns = document.querySelectorAll('.dropdown-select');
        dropdowns.forEach(dropdown => {
            const labelElement = dropdown.parentElement.querySelector('.dropdown-label');
            if (!labelElement) return;

            const label = cleanLabelText(labelElement); // Use the corrected label
            const optionName = labelToOption[label];
            if (optionName) {
                // Convert select value to appropriate type
                const value = dropdown.value;

                // Special handling for specific options (logic remains the same)
                if (optionName === 'goal') {
                    const goalMap = ['shadow_queen', 'crystal_stars', 'bonetail'];
                    gameSettings[optionName] = goalMap[parseInt(value)] || 'shadow_queen';
                } else if (optionName === 'pit_items') {
                    const pitMap = ['vanilla', 'filler', 'all'];
                    gameSettings[optionName] = pitMap[parseInt(value)] || 'filler';
                } else if (optionName === 'accessibility') {
                    const accessibilityMap = ['full', 'minimal'];
                    gameSettings[optionName] = accessibilityMap[parseInt(value)] || 'full';
                } else if (optionName === 'music_settings') {
                    const musicMap = ['normal', 'silent', 'randomized'];
                    gameSettings[optionName] = musicMap[parseInt(value)] || 'normal';
                } else if (optionName === 'block_visibility') {
                    const visibilityMap = ['normal', 'all_visible'];
                    gameSettings[optionName] = visibilityMap[parseInt(value)] || 'normal';
                } else if (optionName === 'piecesanity') {
                    const piecesanityMap = ['vanilla', 'nonpanel_only', 'all'];
                    gameSettings[optionName] = piecesanityMap[parseInt(value)] || 'nonpanel_only';
                } else if (optionName === 'star_shuffle') {
                    const starShuffleMap = { '1': 'vanilla', '2': 'stars_only', '3': 'all' };
                    gameSettings[optionName] = starShuffleMap[value] || 'vanilla';
                } else if (optionName === 'dazzle_rewards') {
                    const dazzleMap = { '1': 'vanilla', '2': 'filler', '3': 'all' };
                    gameSettings[optionName] = dazzleMap[value] || 'all';
                } else if (optionName === 'starting_partner') {
                    const partnerMap = {
                        '1': 'goombella',
                        '2': 'koops',
                        '3': 'bobbery',
                        '4': 'yoshi',
                        '5': 'flurrie',
                        '6': 'vivian',
                        '7': 'ms_mowz',
                        '8': 'random'
                    };
                    gameSettings[optionName] = partnerMap[value] || 'goombella';
                } else if (optionName === 'yoshi_color') {
                    const colorMap = {
                        '0': 'green',
                        '1': 'red',
                        '2': 'blue',
                        '3': 'orange',
                        '4': 'pink',
                        '5': 'black',
                        '6': 'white',
                        '7': 'random'
                    };
                    gameSettings[optionName] = colorMap[value] || 'green';
                } else {
                    gameSettings[optionName] = value;
                }
            }
        });

        // Collect text inputs
        const textInputs = document.querySelectorAll('.text-input');
        textInputs.forEach(input => {
            const labelElement = input.parentElement.querySelector('.text-label');
            if (!labelElement) return;

            const label = cleanLabelText(labelElement); // Use the corrected label
            const optionName = labelToOption[label];
            if (optionName) {
                gameSettings[optionName] = input.value;
            }
        });

        // Collect number inputs
        const numberInputs = document.querySelectorAll('.number-input');
        numberInputs.forEach(input => {
            const labelElement = input.parentElement.querySelector('.number-label');
            if (!labelElement) return;

            const label = cleanLabelText(labelElement); // Use the corrected label
            const optionName = labelToOption[label];
            if (optionName) {
                gameSettings[optionName] = parseInt(input.value) || 0;
            }
        });

        return settings;
    }

    /**
     * Show generation results (fallback if ROM processing isn't available)
     */
    function showGenerationResults(result) {
        console.log('ðŸ“Š Generation Results:');
        console.log(`Seed: ${result.seed}`);
        console.log(`Items placed: ${result.statistics.totalItems}`);
        console.log(`Locations used: ${result.statistics.totalLocations}`);
        console.log('Placements:', result.placements);

        // Could show a detailed results modal here
        const summary = `
        Seed: ${result.seed}
        Items placed: ${result.statistics.totalItems}
        Locations: ${result.statistics.totalLocations}
        Algorithm: ${result.metadata.algorithm}
        Accessibility: ${result.metadata.accessibility}
    `;

        showModal('Generation Complete', summary);
    }

    /**
     * Toggle switch functionality (existing function enhanced)
     */
    function toggleSwitch(element) {
        element.classList.toggle('active');
    }

    /**
     * Switch between tabs in the settings panel
     */
    function switchTab(button, tabId) {
        // Remove active class from all tabs and content
        const tabs = document.querySelectorAll('.panel-tab');
        const contents = document.querySelectorAll('.panel-content');

        tabs.forEach(tab => tab.classList.remove('active'));
        contents.forEach(content => content.classList.remove('active'));

        // Add active class to clicked tab and corresponding content
        button.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    /**
     * Modal system functions
     */
    function showModal(title, message, buttons = [{ text: 'OK', action: () => hideModal() }]) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = message;

        const modalButtons = document.getElementById('modalButtons');
        modalButtons.innerHTML = '';

        buttons.forEach(button => {
            const btn = document.createElement('button');
            btn.textContent = button.text;
            btn.className = 'modal-button';
            btn.onclick = button.action;
            modalButtons.appendChild(btn);
        });

        document.getElementById('modalOverlay').classList.add('show');
    }

    function hideModal() {
        const modalOverlay = document.getElementById('modalOverlay');
        modalOverlay.classList.remove('show');
        // Hide input field when closing modal
        const modalInput = document.getElementById('modalInput');
        if (modalInput) {
            modalInput.style.display = 'none';
        }
    }

    // Close modal when clicking overlay
    document.getElementById('modalOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
            hideModal();
        }
    });

    /**
     * Preset management functions with localStorage support
     */

// Load custom presets from localStorage
    function loadCustomPresets() {
        try {
            const stored = localStorage.getItem('ttyd_custom_presets');
            return stored ? JSON.parse(stored) : {};
        } catch (error) {
            console.error('Error loading custom presets:', error);
            return {};
        }
    }

    // Save custom presets to localStorage
    function saveCustomPresets(presets) {
        try {
            localStorage.setItem('ttyd_custom_presets', JSON.stringify(presets));
        } catch (error) {
            console.error('Error saving custom presets:', error);
            showModal('Error', 'Failed to save preset to storage.');
        }
    }

    // Populate the dropdown with custom presets
    function populateCustomPresets() {
        const dropdown = document.querySelector('.preset-dropdown');
        const customPresets = loadCustomPresets();

        // Remove old custom presets from dropdown (keep only built-in ones)
        const options = Array.from(dropdown.options);
        options.forEach(option => {
            if (option.dataset.custom === 'true') {
                dropdown.removeChild(option);
            }
        });

        // Add custom presets
        Object.keys(customPresets).forEach(name => {
            const option = document.createElement('option');
            option.textContent = name;
            option.dataset.settings = customPresets[name];
            option.dataset.custom = 'true';
            dropdown.appendChild(option);
        });

        // Update delete button visibility
        updateDeleteButtonVisibility();
    }

    // Update delete button visibility based on selection
    function updateDeleteButtonVisibility() {
        const dropdown = document.querySelector('.preset-dropdown');
        const selected = dropdown.options[dropdown.selectedIndex];
        const deleteBtn = document.getElementById('deletePresetBtn');

        if (selected && selected.dataset.custom === 'true') {
            deleteBtn.style.display = 'inline-block';
        } else {
            deleteBtn.style.display = 'none';
        }
    }

    function exportToField() {
        const settings = collectSettingsFromUI();
        const encoded = btoa(JSON.stringify(settings));
        document.getElementById('settingsStringInput').value = encoded;
    }

    function importFromField() {
        const encoded = document.getElementById('settingsStringInput').value.trim();
        if (!encoded) {
            showModal('Error', 'Please paste a settings string first.');
            return;
        }

        try {
            const settings = JSON.parse(atob(encoded));
            applySettingsToUI(settings);
            showModal('Success', 'Settings imported successfully!');
        } catch (error) {
            showModal('Error', 'Invalid settings string: ' + error.message);
        }
    }

    function loadPreset() {
        const dropdown = document.querySelector('.preset-dropdown');
        const selected = dropdown.options[dropdown.selectedIndex];

        if (selected && selected.dataset.settings) {
            try {
                const settings = JSON.parse(atob(selected.dataset.settings));
                applySettingsToUI(settings);
                console.log('Preset loaded:', settings);
            } catch (error) {
                showModal('Error', 'Failed to load preset: ' + error.message);
            }
        }

        // Update delete button visibility
        updateDeleteButtonVisibility();
    }

    function savePreset() {
        const settings = collectSettingsFromUI();
        const encoded = btoa(JSON.stringify(settings));

        // Show modal with input field for preset name
        const modalOverlay = document.getElementById('modalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalInput = document.getElementById('modalInput');
        const modalButtons = document.getElementById('modalButtons');

        modalTitle.textContent = 'Save Preset';
        modalMessage.textContent = 'Enter a name for this preset:';
        modalInput.style.display = 'block';
        modalInput.value = '';
        modalInput.placeholder = 'Preset Name';

        modalButtons.innerHTML = '';

        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'Save';
        saveBtn.className = 'modal-button';
        saveBtn.onclick = () => {
            const presetName = modalInput.value.trim();
            if (!presetName) {
                showModal('Error', 'Please enter a preset name');
                return;
            }

            // Save to localStorage
            const customPresets = loadCustomPresets();
            customPresets[presetName] = encoded;
            saveCustomPresets(customPresets);

            // Refresh dropdown
            populateCustomPresets();

            // Select the new preset
            const dropdown = document.querySelector('.preset-dropdown');
            const options = Array.from(dropdown.options);
            const newOption = options.find(opt => opt.textContent === presetName);
            if (newOption) {
                dropdown.value = newOption.value;
            }

            // Update delete button visibility for the newly selected custom preset
            updateDeleteButtonVisibility();

            modalInput.style.display = 'none';
            hideModal();
            showModal('Success', `Preset "${presetName}" saved successfully!`);
        };

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.className = 'modal-button';
        cancelBtn.onclick = () => {
            modalInput.style.display = 'none';
            hideModal();
        };

        const exportBtn = document.createElement('button');
        exportBtn.textContent = 'Export String';
        exportBtn.className = 'modal-button';
        exportBtn.onclick = () => {
            navigator.clipboard.writeText(encoded);
            modalInput.style.display = 'none';
            hideModal();
            showModal('Success', 'Settings string copied to clipboard!');
        };

        modalButtons.appendChild(saveBtn);
        modalButtons.appendChild(exportBtn);
        modalButtons.appendChild(cancelBtn);

        // Use class-based approach to show modal
        modalOverlay.classList.add('show');
    }

    function deleteCurrentPreset() {
        const dropdown = document.querySelector('.preset-dropdown');
        const selected = dropdown.options[dropdown.selectedIndex];

        if (!selected || selected.dataset.custom !== 'true') {
            showModal('Error', 'Cannot delete built-in presets.');
            return;
        }

        const presetName = selected.textContent;

        showModal('Confirm Delete', `Are you sure you want to delete "${presetName}"?`, [
            {
                text: 'Delete',
                action: () => {
                    const customPresets = loadCustomPresets();
                    delete customPresets[presetName];
                    saveCustomPresets(customPresets);

                    // Refresh dropdown
                    populateCustomPresets();

                    // Select default option
                    dropdown.selectedIndex = 0;
                    updateDeleteButtonVisibility();

                    hideModal();
                    showModal('Success', `Preset "${presetName}" deleted successfully!`);
                }
            },
            {
                text: 'Cancel',
                action: () => hideModal()
            }
        ]);
    }

    function applySettingsToUI(settings) {
        // Extract game settings if in YAML format
        const gameSettings = settings["Paper Mario: The Thousand-Year Door"] || settings;

        // Helper function to clean label text (strip trailing non-word characters like '?')
        const cleanLabelText = (element) => {
            let label = element.textContent.trim();
            label = label.replace(/\W+$/, '').trim();
            return label;
        };

        // Reverse mapping from YAML option names to UI labels
        const optionToLabel = {
            // Logic & Progression
            'goal': 'Goal',
            'goal_stars': 'Goal Crystal Stars',
            'palace_stars': 'Palace Crystal Stars',
            'pit_items': 'Pit Items',
            'progression_balancing': 'Progression Balancing',
            'accessibility': 'Accessibility',
            'death_link': 'Death Link',
            'tattlesanity': 'Tattlesanity',
            'piecesanity': 'Piecesanity',
            'shopsanity': 'Shopsanity',
            'shinesanity': 'Shinesanity',
            'star_shuffle': 'Star Shuffle',
            'dazzle_rewards': 'Dazzle Rewards',
            'limit_chapter_logic': 'Limit Chapter Logic',
            'limit_chapter_eight': 'Limit Chapter 8',

            // World & Gameplay
            'palace_skip': 'Palace Skip',
            'cutscene_skip': 'Skip Cutscenes',
            'disable_intermissions': 'Disable Intermissions',
            'open_westside': 'Open West Side',
            'fast_travel': 'Fast Travel',
            'succeed_conditions': 'Always Succeed Conditions',

            // Starting Stats
            'starting_hp': 'Starting HP',
            'starting_fp': 'Starting FP',
            'starting_bp': 'Starting BP',
            'starting_coins': 'Starting Coins',
            'starting_level': 'Starting Level',
            'experience_multiplier': 'Experience Multiplier',
            'starting_partner': 'Starting Partner',

            // Quality of Life
            'permanent_peekaboo': 'Permanent Peekaboo',
            'full_run_bar': 'Full Run Bar',
            'first_attack': 'First Attack',
            'music_settings': 'Music Settings',
            'block_visibility': 'Block Visibility',
            'yoshi_color': 'Yoshi Color',
            'yoshi_name': 'Yoshi Name'
        };

        Object.entries(gameSettings).forEach(([optionName, value]) => {
            const label = optionToLabel[optionName];
            if (!label) return;

            // Handle toggles
            const toggleElement = Array.from(document.querySelectorAll('.toggle-label'))
                .find(el => cleanLabelText(el) === label)
                ?.parentElement.querySelector('.toggle-switch');
            if (toggleElement) {
                if (value === true || value === 'true') {
                    toggleElement.classList.add('active');
                } else {
                    toggleElement.classList.remove('active');
                }
                return;
            }

            // Handle dropdowns
            const dropdownElement = Array.from(document.querySelectorAll('.dropdown-label'))
                .find(el => cleanLabelText(el) === label)
                ?.parentElement.querySelector('.dropdown-select');
            if (dropdownElement) {
                // Convert YAML value to dropdown index
                let dropdownValue = 0;
                if (optionName === 'goal') {
                    const goalMap = { 'shadow_queen': 0, 'crystal_stars': 1, 'bonetail': 2 };
                    dropdownValue = goalMap[value] !== undefined ? goalMap[value] : 0;
                } else if (optionName === 'pit_items') {
                    const pitMap = { 'vanilla': 0, 'filler': 1, 'all': 2 };
                    dropdownValue = pitMap[value] !== undefined ? pitMap[value] : 1;
                } else if (optionName === 'accessibility') {
                    const accessMap = { 'full': 0, 'minimal': 1 };
                    dropdownValue = accessMap[value] !== undefined ? accessMap[value] : 0;
                } else if (optionName === 'music_settings') {
                    const musicMap = { 'normal': 0, 'silent': 1, 'randomized': 2 };
                    dropdownValue = musicMap[value] !== undefined ? musicMap[value] : 0;
                } else if (optionName === 'block_visibility') {
                    const visMap = { 'normal': 0, 'all_visible': 1 };
                    dropdownValue = visMap[value] !== undefined ? visMap[value] : 0;
                } else if (optionName === 'piecesanity') {
                    const piecesanityMap = { 'vanilla': 0, 'nonpanel_only': 1, 'all': 2 };
                    dropdownValue = piecesanityMap[value] !== undefined ? piecesanityMap[value] : 1;
                } else if (optionName === 'star_shuffle') {
                    const starShuffleMap = { 'vanilla': 1, 'stars_only': 2, 'all': 3 };
                    dropdownValue = starShuffleMap[value] !== undefined ? starShuffleMap[value] : 1;
                } else if (optionName === 'dazzle_rewards') {
                    const dazzleMap = { 'vanilla': 1, 'filler': 2, 'all': 3 };
                    dropdownValue = dazzleMap[value] !== undefined ? dazzleMap[value] : 3;
                } else if (optionName === 'starting_partner') {
                    const partnerMap = {
                        'goombella': 1, 'koops': 2, 'bobbery': 3, 'yoshi': 4,
                        'flurrie': 5, 'vivian': 6, 'ms_mowz': 7, 'random': 8, 'random_partner': 8
                    };
                    dropdownValue = partnerMap[value] !== undefined ? partnerMap[value] : 1;
                } else if (optionName === 'yoshi_color') {
                    const colorMap = {
                        'green': 0, 'red': 1, 'blue': 2, 'orange': 3,
                        'pink': 4, 'black': 5, 'white': 6, 'random': 7, 'random_color': 7
                    };
                    dropdownValue = colorMap[value] !== undefined ? colorMap[value] : 0;
                }
                dropdownElement.value = dropdownValue;
                return;
            }

            // Handle number inputs
            const numberElement = Array.from(document.querySelectorAll('.number-label'))
                .find(el => cleanLabelText(el) === label)
                ?.parentElement.querySelector('.number-input');
            if (numberElement) {
                numberElement.value = value;
                return;
            }

            // Handle text inputs
            const textElement = Array.from(document.querySelectorAll('.text-label'))
                .find(el => cleanLabelText(el) === label)
                ?.parentElement.querySelector('.text-input');
            if (textElement) {
                textElement.value = value;
                return;
            }
        });
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('TTYD Randomizer Generate page loaded with Flask backend integration');

        // Load custom presets from localStorage
        populateCustomPresets();

        // Add change listener to preset dropdown to update delete button visibility
        const dropdown = document.querySelector('.preset-dropdown');
        dropdown.addEventListener('change', updateDeleteButtonVisibility);

        // Check for most recent seed and show link if exists
        showMostRecentSeedLink();
    });

    /**
     * Show link to most recent seed if one exists in localStorage
     */
    function showMostRecentSeedLink() {
        const recentSeedId = localStorage.getItem('ttyd_most_recent_seed');

        if (recentSeedId) {
            const recentSeedLink = document.getElementById('recentSeedLink');
            recentSeedLink.href = `/result/${recentSeedId}`;
            recentSeedLink.style.display = 'inline-block';

            console.log('Most recent seed ID:', recentSeedId);
        }
    }

    /**
     * Load and parse a .ttydp patch file
     */
    async function loadPatchFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            // Read file as ArrayBuffer
            const arrayBuffer = await file.arrayBuffer();
            const data = new Uint8Array(arrayBuffer);

            // Verify magic header: "TTYDPATCH"
            const magic = new TextDecoder().decode(data.slice(0, 9));
            if (magic !== 'TTYDPATCH') {
                throw new Error('Invalid patch file format');
            }

            // Get version
            const version = data[9];
            console.log(`Loading patch file version ${version}`);

            // Extract and deobfuscate data
            const obfuscatedData = data.slice(10);
            const deobfuscatedData = deobfuscatePatchData(obfuscatedData);

            // Parse JSON
            const jsonStr = new TextDecoder().decode(deobfuscatedData);
            const patchData = JSON.parse(jsonStr);

            console.log('Loaded patch data:', patchData);

            // Store in sessionStorage and redirect to result page
            const seedData = {
                locations: patchData.locations,
                seed: patchData.seed,
                required_chapters: patchData.required_chapters,
                settings: patchData.settings,
                timestamp: patchData.timestamp
            };

            sessionStorage.setItem('ttydSeedData', JSON.stringify(seedData));

            // Redirect to patch page
            showModal('Patch Loaded', `Successfully loaded seed ${patchData.seed}. Redirecting to patch page...`, [
                {
                    text: 'Continue',
                    action: () => {
                        hideModal();
                        window.location.href = '/patch';
                    }
                }
            ]);

        } catch (error) {
            console.error('Error loading patch file:', error);
            showModal('Error', `Failed to load patch file: ${error.message}`);
        }

        // Clear file input
        event.target.value = '';
    }

    /**
     * Deobfuscate patch data using XOR
     */
    function deobfuscatePatchData(data) {
        const key = new Uint8Array([0x54, 0x54, 0x59, 0x44, 0x50, 0x41, 0x54, 0x43, 0x48]); // "TTYDPATCH"
        const deobfuscated = new Uint8Array(data.length);

        for (let i = 0; i < data.length; i++) {
            deobfuscated[i] = data[i] ^ key[i % key.length];
        }

        return deobfuscated;
    }
</script>
</div>

<footer class="footer">
    <div class="footer-content">
        <div class="footer-links">
            <a href="https://discord.gg/Ug6nMjmR6F" class="footer-link" target="_blank" rel="noopener noreferrer">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                </svg>
                Discord
            </a>
            <a href="https://github.com/jamesbrq/ArchipelagoTTYD" class="footer-link" target="_blank" rel="noopener noreferrer">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                GitHub
            </a>
            <a href="https://github.com/jamesbrq/ArchipelagoTTYD/issues" class="footer-link" target="_blank" rel="noopener noreferrer">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                Report Issue
            </a>
        </div>
        <div class="footer-divider"></div>
        <p class="footer-text">
            Paper Mario: The Thousand-Year Door Randomizer<br>
            Created by jamesbrq<br>
            <span id="seedStats" style="font-size: 0.9em; opacity: 0.8;">Loading stats...</span><br>
                <span style="font-size: 0.85em; opacity: 0.7;">Last Updated: October 11, 2025</span>
        </p>
    </div>
</footer>
<script>
    // Plando functionality
    let plandoCounter = 0;
    let locationsData = [];
    let itemsData = [];

    // Load locations and items data on page load
    async function loadPlandoData() {
        try {
            const [locationsResponse, itemsResponse] = await Promise.all([
                fetch('/static/json/locations.json'),
                fetch('/static/json/items.json')
            ]);

            locationsData = await locationsResponse.json();
            itemsData = await itemsResponse.json();

            // Sort alphabetically for easier selection
            locationsData.sort((a, b) => a.name.localeCompare(b.name));
            itemsData.sort((a, b) => a.item_name.localeCompare(b.item_name));

            console.log('Plando data loaded:', locationsData.length, 'locations,', itemsData.length, 'items');
        } catch (error) {
            console.error('Failed to load plando data:', error);
        }
    }

    function addPlandoEntry() {
        if (locationsData.length === 0 || itemsData.length === 0) {
            showModal('Error', 'Plando data is still loading. Please try again in a moment.');
            return;
        }

        const container = document.getElementById('plandoContainer');
        const entryId = plandoCounter++;

        const entryDiv = document.createElement('div');
        entryDiv.className = 'plando-entry';
        entryDiv.id = `plando-entry-${entryId}`;
        entryDiv.style.cssText = 'background: #f5f5f5; padding: 15px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ddd;';

        entryDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: start;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Location:</label>
                    <select class="dropdown-select plando-location" style="width: 100%;">
                        <option value="">Select Location...</option>
                        ${locationsData.map(loc => `<option value="${loc.name}">${loc.name}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Item:</label>
                    <select class="dropdown-select plando-item" style="width: 100%;">
                        <option value="">Select Item...</option>
                        ${itemsData.map(item => `<option value="${item.item_name}">${item.item_name}</option>`).join('')}
                    </select>
                </div>
                <div style="padding-top: 25px;">
                    <button class="preset-button" onclick="removePlandoEntry(${entryId})"
                            style="background: #d9534f; padding: 8px 15px;">Remove</button>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" class="plando-from-pool" checked style="margin-right: 8px;">
                    <span style="font-size: 0.9em;">Remove from item pool (uncheck to duplicate item)</span>
                </label>
            </div>
        `;

        container.appendChild(entryDiv);
    }

    function removePlandoEntry(entryId) {
        const entry = document.getElementById(`plando-entry-${entryId}`);
        if (entry) {
            entry.remove();
        }
    }

    function collectPlandoItems() {
        const container = document.getElementById('plandoContainer');
        const entries = container.querySelectorAll('.plando-entry');
        const plandoItems = [];

        entries.forEach(entry => {
            const location = entry.querySelector('.plando-location').value;
            const item = entry.querySelector('.plando-item').value;
            const fromPool = entry.querySelector('.plando-from-pool').checked;

            if (location && item) {
                plandoItems.push({
                    location: location,
                    item: item,
                    from_pool: fromPool
                });
            }
        });

        return plandoItems.length > 0 ? plandoItems : null;
    }

    // Load plando data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadPlandoData();
    });

    // Fetch and display seed statistics
    async function updateSeedStats() {
        try {
            const response = await fetch('/api/stats');
            const stats = await response.json();

            const statsElement = document.getElementById('seedStats');
            if (statsElement) {
                let statsText = 'Total Seeds Generated: ' + stats.total_seeds.toLocaleString();

                if (stats.last_generation) {
                    const lastGen = new Date(stats.last_generation);
                    const now = new Date();
                    const diffMs = now - lastGen;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);

                    let timeAgo;
                    if (diffMins < 1) {
                        timeAgo = 'just now';
                    } else if (diffMins < 60) {
                        timeAgo = diffMins + ' minute' + (diffMins !== 1 ? 's' : '') + ' ago';
                    } else if (diffHours < 24) {
                        timeAgo = diffHours + ' hour' + (diffHours !== 1 ? 's' : '') + ' ago';
                    } else {
                        timeAgo = diffDays + ' day' + (diffDays !== 1 ? 's' : '') + ' ago';
                    }

                    statsText += ' | Last seed: ' + timeAgo;
                }

                statsElement.textContent = statsText;
            }
        } catch (error) {
            console.error('Error fetching seed stats:', error);
            const statsElement = document.getElementById('seedStats');
            if (statsElement) {
                statsElement.textContent = 'Stats unavailable';
            }
        }
    }

    // Update stats on page load
    document.addEventListener('DOMContentLoaded', updateSeedStats);
</script>

</body>
</html>
