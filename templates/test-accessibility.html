<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTYD Randomizer - Location Accessibility Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .controls {
            margin-bottom: 30px;
            text-align: center;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .stat-card .number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        
        .filters {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .location-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .location-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background: white;
            transition: all 0.3s;
        }
        
        .location-card.accessible {
            border-color: #27ae60;
            background: #f8fff8;
        }
        
        .location-card.inaccessible {
            border-color: #e74c3c;
            background: #fff8f8;
        }
        
        .location-card.no-rules {
            border-color: #f39c12;
            background: #fffbf0;
        }
        
        .location-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .location-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .location-tags {
            margin-bottom: 8px;
        }
        
        .tag {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 4px;
            margin-bottom: 2px;
        }
        
        .rules {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 3px;
            margin-top: 8px;
            font-size: 12px;
        }
        
        .rules-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .rule {
            background: white;
            padding: 4px;
            margin: 2px 0;
            border-radius: 2px;
            font-family: monospace;
            word-break: break-all;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status.accessible {
            background: #27ae60;
            color: white;
        }
        
        .status.inaccessible {
            background: #e74c3c;
            color: white;
        }
        
        .status.no-rules {
            background: #f39c12;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #7f8c8d;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-top: 30px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TTYD Randomizer - Location Accessibility Test</h1>
        
        <div class="controls">
            <button id="runTest" onclick="runAccessibilityTest()">Test Empty State</button>
            <button id="runFullTest" onclick="runAccessibilityTestWithAllItems()">Test All Items State</button>
            <button id="clearLog" onclick="clearLog()">Clear Log</button>
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="loading" class="loading" style="display: none;">
            Loading locations and initializing game state...
        </div>
        
        <div id="stats" class="stats" style="display: none;">
            <div class="stat-card">
                <h3>Total Locations</h3>
                <div class="number" id="totalLocations">0</div>
            </div>
            <div class="stat-card">
                <h3>Accessible</h3>
                <div class="number" id="accessibleCount" style="color: #27ae60;">0</div>
            </div>
            <div class="stat-card">
                <h3>Inaccessible</h3>
                <div class="number" id="inaccessibleCount" style="color: #e74c3c;">0</div>
            </div>
            <div class="stat-card">
                <h3>No Rules</h3>
                <div class="number" id="noRulesCount" style="color: #f39c12;">0</div>
            </div>
            <div class="stat-card">
                <h3>With Rules</h3>
                <div class="number" id="withRulesCount">0</div>
            </div>
            <div class="stat-card">
                <h3>Accessibility Rate</h3>
                <div class="number" id="accessibilityRate">0%</div>
            </div>
        </div>
        
        <div id="filters" class="filters" style="display: none;">
            <div class="filter-group">
                <label for="statusFilter">Status:</label>
                <select id="statusFilter" onchange="filterLocations()">
                    <option value="all">All</option>
                    <option value="accessible">Accessible Only</option>
                    <option value="inaccessible">Inaccessible Only</option>
                    <option value="no-rules">No Rules Only</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="regionFilter">Region:</label>
                <select id="regionFilter" onchange="filterLocations()">
                    <option value="all">All Regions</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="searchFilter">Search:</label>
                <input type="text" id="searchFilter" placeholder="Location name..." onkeyup="filterLocations()">
            </div>
        </div>
        
        <div id="locationContainer" class="location-grid" style="display: none;">
        </div>
        
        <div id="log" class="log" style="display: none;">
            <strong>Console Log:</strong><br>
            <div id="logContent"></div>
        </div>
    </div>

    <!-- Include required JavaScript files -->
    <script src="{{ url_for('static', filename='js/location.js') }}"></script>
    <script src="{{ url_for('static', filename='js/itemPool.js') }}"></script>
    <script src="{{ url_for('static', filename='js/parser.js') }}"></script>
    <script src="{{ url_for('static', filename='js/gameState.js') }}"></script>

    <script>
        let gameState = null;
        let allLocations = [];
        let filteredLocations = [];
        let testResults = [];

        // Override console.log to capture logs
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            appendLog('LOG', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            appendLog('WARN', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            appendLog('ERROR', args.join(' '));
        };

        function appendLog(level, message) {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `[${timestamp}] ${level}: ${message}<br>`;
            logContent.scrollTop = logContent.scrollHeight;
            document.getElementById('log').style.display = 'block';
        }

        function clearLog() {
            document.getElementById('logContent').innerHTML = '';
            document.getElementById('log').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        async function runAccessibilityTest() {
            const runButton = document.getElementById('runTest');
            runButton.disabled = true;
            runButton.textContent = 'Testing...';
            
            hideError();
            document.getElementById('loading').style.display = 'block';
            document.getElementById('stats').style.display = 'none';
            document.getElementById('filters').style.display = 'none';
            document.getElementById('locationContainer').style.display = 'none';

            try {
                console.log('Starting accessibility test...');
                
                // Initialize empty game state with locations for testing
                console.log('Creating empty state with locations...');
                gameState = await GameState.createEmptyStateWithLocations(true);
                
                if (!gameState.getLocations()) {
                    throw new Error('Failed to initialize locations');
                }
                
                console.log('Empty game state initialized successfully');
                console.log('Game state stats:', gameState.getStats());
                
                // Get all locations
                allLocations = gameState.getLocations().locations;
                console.log(`Testing accessibility for ${allLocations.length} locations`);
                
                // Test accessibility for each location
                testResults = [];
                let accessibleCount = 0;
                let inaccessibleCount = 0;
                let noRulesCount = 0;
                
                for (const location of allLocations) {
                    const hasRules = location.rules && location.rules.length > 0;
                    let isAccessible = false;
                    let error = null;
                    
                    if (hasRules) {
                        try {
                            isAccessible = location.isAccessible(gameState);
                            if (isAccessible) {
                                accessibleCount++;
                            } else {
                                inaccessibleCount++;
                            }
                        } catch (e) {
                            error = e.message;
                            inaccessibleCount++;
                            console.warn(`Error testing accessibility for ${location.name}:`, e);
                        }
                    } else {
                        // No rules = accessible by default
                        isAccessible = true;
                        noRulesCount++;
                    }
                    
                    testResults.push({
                        location,
                        isAccessible,
                        hasRules,
                        error
                    });
                }
                
                console.log(`Test complete: ${accessibleCount} accessible, ${inaccessibleCount} inaccessible, ${noRulesCount} no rules`);
                
                // Update statistics
                updateStats(accessibleCount, inaccessibleCount, noRulesCount);
                
                // Populate region filter
                populateRegionFilter();
                
                // Display results
                filteredLocations = testResults;
                displayLocations();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('stats').style.display = 'grid';
                document.getElementById('filters').style.display = 'flex';
                document.getElementById('locationContainer').style.display = 'grid';
                
            } catch (error) {
                console.error('Test failed:', error);
                showError(`Test failed: ${error.message}`);
                document.getElementById('loading').style.display = 'none';
            } finally {
                runButton.disabled = false;
                runButton.textContent = 'Test Empty State';
            }
        }

        async function runAccessibilityTestWithAllItems() {
            const runButton = document.getElementById('runFullTest');
            runButton.disabled = true;
            runButton.textContent = 'Testing...';
            
            hideError();
            document.getElementById('loading').style.display = 'block';
            document.getElementById('stats').style.display = 'none';
            document.getElementById('filters').style.display = 'none';
            document.getElementById('locationContainer').style.display = 'none';

            try {
                console.log('Starting accessibility test with all items...');
                
                // Initialize game state with all items and locations
                console.log('Creating all items state...');
                gameState = await GameState.createAllItemsState(true);
                
                if (!gameState.getLocations()) {
                    throw new Error('Failed to initialize locations');
                }
                
                console.log('All items game state initialized successfully');
                console.log('Game state stats:', gameState.getStats());
                
                // Get all locations
                allLocations = gameState.getLocations().locations;
                console.log(`Testing accessibility for ${allLocations.length} locations with all items`);
                
                // Test accessibility for each location
                testResults = [];
                let accessibleCount = 0;
                let inaccessibleCount = 0;
                let noRulesCount = 0;
                
                for (const location of allLocations) {
                    const hasRules = location.rules && location.rules.length > 0;
                    let isAccessible = false;
                    let error = null;
                    
                    if (hasRules) {
                        try {
                            isAccessible = location.isAccessible(gameState);
                            if (isAccessible) {
                                accessibleCount++;
                            } else {
                                inaccessibleCount++;
                            }
                        } catch (e) {
                            error = e.message;
                            inaccessibleCount++;
                            console.warn(`Error testing accessibility for ${location.name}:`, e);
                        }
                    } else {
                        // No rules = accessible by default
                        isAccessible = true;
                        noRulesCount++;
                    }
                    
                    testResults.push({
                        location,
                        isAccessible,
                        hasRules,
                        error
                    });
                }
                
                console.log(`All items test complete: ${accessibleCount} accessible, ${inaccessibleCount} inaccessible, ${noRulesCount} no rules`);
                
                // Update statistics
                updateStats(accessibleCount, inaccessibleCount, noRulesCount);
                
                // Populate region filter
                populateRegionFilter();
                
                // Display results
                filteredLocations = testResults;
                displayLocations();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('stats').style.display = 'grid';
                document.getElementById('filters').style.display = 'flex';
                document.getElementById('locationContainer').style.display = 'grid';
                
            } catch (error) {
                console.error('All items test failed:', error);
                showError(`All items test failed: ${error.message}`);
                document.getElementById('loading').style.display = 'none';
            } finally {
                runButton.disabled = false;
                runButton.textContent = 'Test All Items State';
            }
        }

        function updateStats(accessible, inaccessible, noRules) {
            const total = allLocations.length;
            const withRules = accessible + inaccessible;
            const accessibilityRate = withRules > 0 ? ((accessible / withRules) * 100).toFixed(1) : 0;
            
            document.getElementById('totalLocations').textContent = total;
            document.getElementById('accessibleCount').textContent = accessible;
            document.getElementById('inaccessibleCount').textContent = inaccessible;
            document.getElementById('noRulesCount').textContent = noRules;
            document.getElementById('withRulesCount').textContent = withRules;
            document.getElementById('accessibilityRate').textContent = accessibilityRate + '%';
        }

        function populateRegionFilter() {
            const regionFilter = document.getElementById('regionFilter');
            const regions = new Set();
            
            // Collect all region tags
            for (const result of testResults) {
                if (result.location.tags) {
                    for (const tag of result.location.tags) {
                        regions.add(tag);
                    }
                }
            }
            
            // Clear existing options (except "All Regions")
            regionFilter.innerHTML = '<option value="all">All Regions</option>';
            
            // Add region options
            const sortedRegions = Array.from(regions).sort();
            for (const region of sortedRegions) {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                regionFilter.appendChild(option);
            }
        }

        function filterLocations() {
            const statusFilter = document.getElementById('statusFilter').value;
            const regionFilter = document.getElementById('regionFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            filteredLocations = testResults.filter(result => {
                // Status filter
                if (statusFilter === 'accessible' && (!result.hasRules || !result.isAccessible)) return false;
                if (statusFilter === 'inaccessible' && (result.isAccessible || !result.hasRules)) return false;
                if (statusFilter === 'no-rules' && result.hasRules) return false;
                
                // Region filter
                if (regionFilter !== 'all') {
                    if (!result.location.tags || !result.location.tags.includes(regionFilter)) return false;
                }
                
                // Search filter
                if (searchFilter && !result.location.name.toLowerCase().includes(searchFilter)) return false;
                
                return true;
            });
            
            displayLocations();
        }

        function displayLocations() {
            const container = document.getElementById('locationContainer');
            container.innerHTML = '';
            
            for (const result of filteredLocations) {
                const card = createLocationCard(result);
                container.appendChild(card);
            }
            
            // Update displayed count in title if needed
            if (filteredLocations.length !== testResults.length) {
                console.log(`Showing ${filteredLocations.length} of ${testResults.length} locations`);
            }
        }

        function createLocationCard(result) {
            const { location, isAccessible, hasRules, error } = result;
            
            const card = document.createElement('div');
            card.className = 'location-card';
            
            if (!hasRules) {
                card.classList.add('no-rules');
            } else if (isAccessible) {
                card.classList.add('accessible');
            } else {
                card.classList.add('inaccessible');
            }
            
            const statusClass = !hasRules ? 'no-rules' : (isAccessible ? 'accessible' : 'inaccessible');
            const statusText = !hasRules ? 'No Rules' : (isAccessible ? 'Accessible' : 'Inaccessible');
            
            let tagsHtml = '';
            if (location.tags && location.tags.length > 0) {
                tagsHtml = location.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
            }
            
            let rulesHtml = '';
            if (hasRules) {
                rulesHtml = `
                    <div class="rules">
                        <div class="rules-title">Rules (${location.rules.length}):</div>
                        ${location.rules.map(rule => `<div class="rule">${JSON.stringify(rule)}</div>`).join('')}
                    </div>
                `;
            }
            
            let errorHtml = '';
            if (error) {
                errorHtml = `<div style="color: #e74c3c; font-weight: bold; margin-top: 5px;">Error: ${error}</div>`;
            }
            
            card.innerHTML = `
                <div class="location-header">
                    ${location.name}
                    <span class="status ${statusClass}">${statusText}</span>
                </div>
                <div class="location-details">
                    ID: ${location.id} | REL: ${location.rel} | Offsets: ${location.offsets.length}
                </div>
                <div class="location-tags">${tagsHtml}</div>
                ${rulesHtml}
                ${errorHtml}
            `;
            
            return card;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded. Choose a test mode:');
            console.log('- "Test Empty State": Tests with no items (shows which locations need rules)');
            console.log('- "Test All Items State": Tests with all items (shows rule effectiveness)');
            appendLog('INFO', 'Page loaded. Ready to test location accessibility with different game states.');
        });
    </script>
</body>
</html>