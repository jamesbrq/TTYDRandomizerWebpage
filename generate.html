<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTYD Randomizer</title>
    <meta name="description" content="A randomizer for the game TTYD, enhancing replayability with randomized items, enemies, and more.">
    <meta name="keywords" content="TTYD, randomizer, game, mod, Mario, Paper Mario, Thousand-Year Door, randomization">
    <link rel="stylesheet" href="css/styles.css">
    <!-- Core dependencies -->
    <script src="js/parser.js"></script>
    <script src="js/gameState.js"></script>
    <script src="js/itemPool.js"></script>
    <script src="js/location.js"></script>
    <script src="js/debugLogger.js"></script>
    <script src="js/generate.js"></script>

    <!-- Optional utilities -->
    <script src="js/spoilerGenerator.js"></script>
    <script type="module" src="js/gciso.js"></script>
</head>
<body>
<div class="header">
    <div class="header-logo">
        <a href="index.html">
            <img src="images/logo.png" alt="Home" class="logo">
        </a>
    </div>
    <div class="header-pages">
        <a href="generate.html" class="pages-link">Seed Generator</a>
        <a href="test.html" class="pages-link">Test</a>
    </div>
</div>

<div class="generate-panel">
    <div class="preset-section">
        <h3 class="preset-header">Preset Settings</h3>
        <div class="preset-controls">
            <select class="preset-dropdown" onchange="loadPreset()">
                <option>Select Preset...</option>
                <option data-settings="eyJSYW5kb21pemUgSXRlbXMiOmZhbHNlLCJSYW5kb21pemUgQmFkZ2VzIjpmYWxzZSwiSW5jbHVkZSBLZXkgSXRlbXMiOnRydWUsIlJhbmRvbWl6ZSBFBW5lbWllcyI6ZmFsc2UsIlNodWZmbGUgTlBDcyI6ZmFsc2UsIlJhbmRvbWl6ZSBTaG9wIFByaWNlcyI6ZmFsc2UsIkhhcmQgTW9kZSI6ZmFsc2UsIkJvc3MgUnVzaCBNb2RlIjpmYWxzZSwiRGlmZmljdWx0eSBMZXZlbCI6MywiU2VlZCBWYWx1ZSI6MCwiRmFzdCBUZXh0Ijp0cnVlLCJEZWJ1ZyBNb2RlIjpmYWxzZX0=">Default Settings</option>
                <option data-settings="eyJSYW5kb21pemUgSXRlbXMiOnRydWUsIlJhbmRvbWl6ZSBCYW5nZXMiOmZhbHNlLCJJbmNsdWRlIEtleSBJdGVtcyI6dHJ1ZSwiUmFuZG9taXplIEVuZW1pZXMiOmZhbHNlLCJTaHVmZmxlIE5QQ3MiOmZhbHNlLCJSYW5kb21pemUgU2hvcCBQcmljZXMiOmZhbHNlLCJIYXJkIE1vZGUiOmZhbHNlLCJCb3NzIFJ1c2ggTW9kZSI6ZmFsc2UsIkRpZmZpY3VsdHkgTGV2ZWwiOjEsIlNlZWQgVmFsdWUiOjAsIkZhc3QgVGV4dCI6dHJ1ZSwiRGVidWcgTW9kZSI6ZmFsc2V9">Beginner Mode</option>
                <option data-settings="eyJSYW5kb21pemUgSXRlbXMiOnRydWUsIlJhbmRvbWl6ZSBCYW5nZXMiOnRydWUsIkluY2x1ZGUgS2V5IEl0ZW1zIjp0cnVlLCJSYW5kb21pemUgRW5lbWllcyI6dHJ1ZSwiU2h1ZmZsZSBOUENzIjp0cnVlLCJSYW5kb21pemUgU2hvcCBQcmljZXMiOnRydWUsIkhhcmQgTW9kZSI6dHJ1ZSwiQm9zcyBSdXNoIE1vZGUiOnRydWUsIkRpZmZpY3VsdHkgTGV2ZWwiOjcsIlNlZWQgVmFsdWUiOjAsIkZhc3QgVGV4dCI6dHJ1ZSwiRGVidWcgTW9kZSI6ZmFsc2V9">Expert Challenge</option>
                <option>Custom Config 1</option>
            </select>
            <button class="preset-button" onclick="savePreset()">Save</button>
            <button class="preset-button" onclick="loadPreset()">Load</button>
            <button class="delete-preset-button" id="deletePresetBtn" onclick="deleteCurrentPreset()" style="display: none;">Delete</button>
        </div>
        
        <div class="settings-string-section">
            <label class="settings-string-label">Settings String</label>
            <div class="settings-string-controls">
                <input type="text" class="settings-string-input" id="settingsStringInput" placeholder="Paste settings string here...">
                <button class="preset-button" onclick="exportToField()">Export</button>
                <button class="preset-button" onclick="importFromField()">Import</button>
            </div>
        </div>
    </div>
    
    <div class="panel-tabs">
        <button class="panel-tab active" onclick="switchTab(this, 'logic')">Logic & Progression</button>
        <button class="panel-tab" onclick="switchTab(this, 'world')">World & Gameplay</button>
        <button class="panel-tab" onclick="switchTab(this, 'stats')">Starting Stats</button>
        <button class="panel-tab" onclick="switchTab(this, 'qol')">Quality of Life</button>
    </div>
    
    <div class="generate-content">
        <!-- Logic & Progression Tab -->
        <div id="logic" class="panel-content active">
            <div class="settings-grid">
                <div class="dropdown-container">
                    <span class="dropdown-label">Goal</span>
                    <select class="dropdown-select goal-dropdown">
                        <option value="0" selected>Shadow Queen</option>
                        <option value="1">Crystal Stars</option>
                        <option value="2">Bonetail</option>
                    </select>
                </div>
                
                <div class="number-container">
                    <span class="number-label">Goal Crystal Stars</span>
                    <input type="number" class="number-input" min="0" max="7" value="7">
                </div>
                
                <div class="number-container">
                    <span class="number-label">Palace Crystal Stars</span>
                    <input type="number" class="number-input" min="0" max="7" value="7">
                </div>
                
                <div class="dropdown-container">
                    <span class="dropdown-label">Pit Items</span>
                    <select class="dropdown-select">
                        <option value="0">Vanilla</option>
                        <option value="1" selected>Filler</option>
                        <option value="2">All</option>
                    </select>
                </div>
                
                <div class="toggle-container">
                    <span class="toggle-label">Tattlesanity</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span class="toggle-label">Limit Chapter Logic</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span class="toggle-label">Limit Chapter 8</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- World & Gameplay Tab -->
        <div id="world" class="panel-content">
            <div class="settings-grid">
                <div class="toggle-container">
                    <span class="toggle-label">Palace Skip</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span class="toggle-label">Skip Cutscenes</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span class="toggle-label">Disable Intermissions</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span class="toggle-label">Open West Side</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span class="toggle-label">Fast Travel</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span class="toggle-label">Always Succeed Conditions</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Starting Stats Tab -->
        <div id="stats" class="panel-content">
            <div class="settings-grid">
                <div class="number-container">
                    <span class="number-label">Starting HP</span>
                    <input type="number" class="number-input" min="1" max="100" value="10">
                </div>
                
                <div class="number-container">
                    <span class="number-label">Starting FP</span>
                    <input type="number" class="number-input" min="0" max="100" value="5">
                </div>
                
                <div class="number-container">
                    <span class="number-label">Starting BP</span>
                    <input type="number" class="number-input" min="0" max="99" value="3">
                </div>
                
                <div class="number-container">
                    <span class="number-label">Starting Coins</span>
                    <input type="number" class="number-input" min="0" max="999" value="100">
                </div>
                
                <div class="dropdown-container">
                    <span class="dropdown-label">Starting Partner</span>
                    <select class="dropdown-select">
                        <option value="1" selected>Goombella</option>
                        <option value="2">Koops</option>
                        <option value="3">Bobbery</option>
                        <option value="4">Yoshi</option>
                        <option value="5">Flurrie</option>
                        <option value="6">Vivian</option>
                        <option value="7">Ms. Mowz</option>
                        <option value="8">Random Partner</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Quality of Life Tab -->
        <div id="qol" class="panel-content">
            <div class="settings-grid">
                <div class="toggle-container">
                    <span class="toggle-label">Permanent Peekaboo</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                
                <div class="toggle-container">
                    <span class="toggle-label">Full Run Bar</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this)">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                
                <div class="dropdown-container">
                    <span class="dropdown-label">Yoshi Color</span>
                    <select class="dropdown-select">
                        <option value="0" selected>Green</option>
                        <option value="1">Red</option>
                        <option value="2">Blue</option>
                        <option value="3">Orange</option>
                        <option value="4">Pink</option>
                        <option value="5">Black</option>
                        <option value="6">White</option>
                        <option value="7">Random Color</option>
                    </select>
                </div>
                
                <div class="text-container">
                    <span class="text-label">Yoshi Name</span>
                    <input type="text" class="text-input" maxlength="8" value="Yoshi">
                </div>
            </div>
        </div>
    </div>
    
    <!-- ROM Selection Section -->
    <div class="iso-generation-section">
        <h3>Select ROM File</h3>
        <div class="iso-controls">
            <input type="file" id="romFileInput" accept=".iso,.gcm" style="display: none;">
            <button class="preset-button" onclick="document.getElementById('romFileInput').click()">Select ROM File</button>
            <span id="selectedROMName" style="margin-left: 10px; font-style: italic; color: #666;"></span>
        </div>
        <div class="iso-controls" style="margin-top: 10px;">
            <button class="preset-button" id="generateBtn" onclick="generateRandomizedROM()">Generate Randomized ROM</button>
        </div>
    </div>
</div>

<!-- Modal System -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <h2 class="modal-title" id="modalTitle"></h2>
        <p class="modal-message" id="modalMessage"></p>
        <input type="text" class="modal-input" id="modalInput" style="display: none;">
        <div class="modal-buttons" id="modalButtons"></div>
    </div>
</div>

<script>
/**
 * Main generation function called by the Generate button
 * Collects settings from UI and calls the new minimalistic generation system
 */
async function generateRandomizedROM() {
    const generateBtn = document.getElementById('generateBtn');
    const originalText = generateBtn.textContent;
    
    try {
        // Disable button and show progress
        generateBtn.disabled = true;
        generateBtn.textContent = 'Generating...';
        
        console.log('ðŸŽ¯ Starting ROM generation...');
        
        // Collect settings from UI
        const settings = collectSettingsFromUI();
        console.log('Collected settings:', settings);
        
        // Generate the randomized seed using new system
        const result = await generate(settings);
        console.log('Generation result:', result);
        
        // Check if ROM file is selected
        const romFile = document.getElementById('romFileInput').files[0];
        if (!romFile) {
            showModal('Error', 'Please select a ROM file first.');
            return;
        }
        
        // Apply randomization to ROM (if gciso.js is available)
        if (typeof applyRandomizationToROM === 'function') {
            generateBtn.textContent = 'Applying to ROM...';
            await applyRandomizationToROM(romFile, result);
        } else {
            // Fallback: show generation results
            showGenerationResults(result);
        }
        
        showModal('Success', `Randomized seed generated successfully! Seed: ${result.seed}`);
        
    } catch (error) {
        console.error('Generation failed:', error);
        showModal('Error', `Generation failed: ${error.message}`);
    } finally {
        // Re-enable button
        generateBtn.disabled = false;
        generateBtn.textContent = originalText;
    }
}

/**
 * Collect all settings from the UI elements
 */
function collectSettingsFromUI() {
    const settings = {};
    
    // Collect toggle switches
    const toggles = document.querySelectorAll('.toggle-switch');
    toggles.forEach(toggle => {
        const label = toggle.parentElement.querySelector('.toggle-label').textContent.trim();
        const isActive = toggle.classList.contains('active');
        settings[label] = isActive;
    });
    
    // Collect dropdowns
    const dropdowns = document.querySelectorAll('.dropdown-select');
    dropdowns.forEach(dropdown => {
        const label = dropdown.parentElement.querySelector('.dropdown-label').textContent.trim();
        settings[label] = dropdown.value;
    });
    
    // Collect text inputs
    const textInputs = document.querySelectorAll('.text-input');
    textInputs.forEach(input => {
        const label = input.parentElement.querySelector('.text-label').textContent.trim();
        settings[label] = input.value;
    });
    
    // Collect numeric inputs
    const numericInputs = document.querySelectorAll('.numeric-input');
    numericInputs.forEach(input => {
        const label = input.parentElement.querySelector('.numeric-label').textContent.trim();
        settings[label] = parseInt(input.value) || 0;
    });
    
    // Add default settings if not specified
    settings.seed = settings.seed || Math.floor(Math.random() * 1000000);
    settings.startingPartner = settings.startingPartner || 'Goombella';
    
    return settings;
}

/**
 * Show generation results (fallback if ROM processing isn't available)
 */
function showGenerationResults(result) {
    console.log('ðŸ“Š Generation Results:');
    console.log(`Seed: ${result.seed}`);
    console.log(`Items placed: ${result.statistics.totalItems}`);
    console.log(`Locations used: ${result.statistics.totalLocations}`);
    console.log('Placements:', result.placements);
    
    // Could show a detailed results modal here
    const summary = `
        Seed: ${result.seed}
        Items placed: ${result.statistics.totalItems}
        Locations: ${result.statistics.totalLocations}
        Algorithm: ${result.metadata.algorithm}
        Accessibility: ${result.metadata.accessibility}
    `;
    
    showModal('Generation Complete', summary);
}

/**
 * Toggle switch functionality (existing function enhanced)
 */
function toggleSwitch(element) {
    element.classList.toggle('active');
}

/**
 * Modal system functions
 */
function showModal(title, message, buttons = [{ text: 'OK', action: () => hideModal() }]) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
    
    const modalButtons = document.getElementById('modalButtons');
    modalButtons.innerHTML = '';
    
    buttons.forEach(button => {
        const btn = document.createElement('button');
        btn.textContent = button.text;
        btn.className = 'modal-button';
        btn.onclick = button.action;
        modalButtons.appendChild(btn);
    });
    
    document.getElementById('modalOverlay').style.display = 'flex';
}

function hideModal() {
    document.getElementById('modalOverlay').style.display = 'none';
}

// Close modal when clicking overlay
document.getElementById('modalOverlay').addEventListener('click', function(e) {
    if (e.target === this) {
        hideModal();
    }
});

/**
 * Preset management functions (simplified versions)
 */
function loadPreset() {
    const dropdown = document.querySelector('.preset-dropdown');
    const selected = dropdown.options[dropdown.selectedIndex];
    
    if (selected.dataset.settings) {
        try {
            const settings = JSON.parse(atob(selected.dataset.settings));
            applySettingsToUI(settings);
            console.log('Preset loaded:', settings);
        } catch (error) {
            showModal('Error', 'Failed to load preset: ' + error.message);
        }
    }
}

function savePreset() {
    const settings = collectSettingsFromUI();
    const encoded = btoa(JSON.stringify(settings));
    
    showModal('Preset Saved', 'Settings string: ' + encoded, [
        { text: 'Copy to Clipboard', action: () => { navigator.clipboard.writeText(encoded); hideModal(); }},
        { text: 'Close', action: () => hideModal() }
    ]);
}

function applySettingsToUI(settings) {
    // Apply settings back to UI elements
    Object.entries(settings).forEach(([key, value]) => {
        // Find corresponding UI element and set its value
        // This is a simplified version - would need more robust mapping
        console.log(`Setting ${key} = ${value}`);
    });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('TTYD Randomizer Generate page loaded with new generation system');
    
    // Update ROM file input handler
    document.getElementById('romFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('selectedROMName').textContent = file.name;
            console.log('ROM file selected:', file.name);
        }
    });
});
</script>
</body>
</html>